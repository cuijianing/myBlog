# url 转码

### 背景
文件上传功能突然被测试小姐姐抓走说，上传错误http 400，定位问题发现她上传了一个叫做《[代码整洁之道].(美)马丁.扫描版》这个文件，一看这么多特殊符号，就感觉不妙，大概率是`编码`出现问题了。

### 什么是url编码
URL编码只是简单的在特殊字符的各个字节前加上`%`，例如，我们对上述会产生奇异的字符进行`URL编码`后结果：`name1=va%26lu%3D`，这样服务端会把紧跟在`%`后的字节当成普通的字节，就是不会把它当成各个参数或键值对的分隔符。

### url为什么需要编码
我们都知道`Http协议`中参数的传输是"key=value"这种键值对形式的，如果要传多个参数就需要用`&`符号对键值对进行分割。如`?name1=value1&name2=value2`，这样在服务端在收到这种字符串的时候，会用`&`分割出每一个参数，然后再用`=`来分割出参数值。

问题来了

`name1=va&lu=`   碰见这种鬼东西怎么办，我得目的是`key是name1`, `value是va&lu`,可是根据上面说的规则看见`&`就被分隔开,这样就出现了问题,编码的功效就来了

### 那些字符需要编码
url的编码是为了解决`特殊字符`跟`url的保留字符`冲突带来的问题，那些不会带来冲突的字符是不会被编码。

> RFC3986文档规定，Url中只允许包含英文字母（a-zA-Z）、数字（0-9）、-_.~4个特殊字符以及所有保留字符

**保留字符**

Url可以划分成若干个组件，协议、主机、路径等。有一些字符（:/?#[]@）是用作分隔不同组件的。例如：`冒号`用于分隔协议和主机，`/`用于分隔主机和路径，`?`用于分隔路径和查询参数，等等。

还有一些字符（!$&'()*+,;=）用于在每个组件中起到分隔作用的，如`=`用于表示查询参数中的键值对，`&`符号用于分隔查询多个键值对。

当组件中的普通数据包含这些特殊字符时，需要对其进行编码。

> RFC3986中指定了以下字符为保留字符：! * ' ( ) ; : @ & = + $ , / ? # [ ]

**不安全字符**
还有一些字符，当他们直接放在Url中的时候，可能会引起解析程序的歧义。这些字符被视为不安全字符，原因有很多。

- `空格`：Url在传输的过程，或者用户在排版的过程，或者文本处理程序在处理Url的过程，都有可能引入无关紧要的空格，或者将那些有意义的空格给去掉。
- `引号以及<>`：引号和尖括号通常用于在普通文本中起到分隔Url的作用
- `#`：通常用于表示书签或者锚点
- `%`：百分号本身用作对不安全字符进行编码时使用的特殊字符，因此本身需要编码
- `{}|\^[]`~`：某一些网关或者传输代理会篡改这些字符 

### JavaScript中的url编码函数
`JavaScript`中提供了3对函数用来对Url编码以得到合法的Url。

下面分别是三个函数以及他的安全字符(即函数不会对这些字符进行编码）

- `escape`（69个）：*/@+-._0-9a-zA-Z
- `encodeURI`（82个）：!#$&'()*+,/:;=?@-._~0-9a-zA-Z
- `encodeURIComponent`（71个）：!'()*-._~0-9a-zA-Z

#### escape

**作用**: 主要是js对字符串进行编码(不常用)

`采用ISO Latin字符集`对指定的字符串进行编码。所有的空格符、标点符号、特殊字符以及其他非ASCII字符都会转化成%xx格式的字符编码（xx代表此字符在字符集表里编码的16进制数字）。比如，空格符的对应编码是%20。不会对ASCII字符和数字进行编码。不会被此方法编码的字符：@ * / +

反向编码函数：`unescape()`。


#### encodeURI
**作用**: url跳转

把`URI字符串`采用`UTF-8编码格式`转化成`escape格式的字符串`。不会被此方法编码的字符：! @ # $ & ( ) = ： / ; ? + '

反向编码函数：`decodeURI()`。

#### encodeURIComponent
**作用**: 参数的传递(参数包含特殊字符可能会造成间断)

把`URI字符串`采用`URF-8编码格式`转化成`escape格式的字符串`。与encodeURI相比，这个函数会将更多的字符进行编码，比如"/"等字符。所以如果字符串里面包含了URI的几个部分的话，不能用这个来进行编码。否则“/”字符被编码后将URL显示错误。不会被此方法编码的字符：! * ( )

反向编码函数：`decodeURIComponent()`

--- 

### 测试
``` js
const url = http://localhost:8080/pro?a=1&b=张三&c=aaa

escape(url) // "http%3A//localhost%3A8080/pro%3Fa%3D1%26b%3D%u5F20%u4E09%26c%3Daaa"

encodeURI(url) // "http://localhost:8080/pro?a=1&b=%E5%BC%A0%E4%B8%89&c=aaa"

encodeURIComponent(url) // "http%3A%2F%2Flocalhost%3A8080%2Fpro%3Fa%3D1%26b%3D%E5%BC%A0%E4%B8%89%26c%3Daaa"

```

### 结论

《[代码整洁之道].(美)马丁.扫描版》这个尽管被编码后依旧400，最后发现是因为`某一些网关或者传输代理会篡改这些字符({}|\^[]~)`, 呼叫后台大佬解决


